 <!-- Written by: Jason Clark -->

<% placeholder = "Enter a city" %>
<div id="container">
  <div id="contentDiv">
    <form action="" id="searchForm" name="searchForm" onsubmit="/search">
      <input type="text" id="searchBox" name="city" class="barInitial" placeholder= "<%= @city.nil? ? 'Enter a city' : @city %>" >
      <input type="button" id="searchButton">
    </form>
   </div>
   <div style='width: 800px;' id="googlemap">
      <%if @listings then %>
         <div id="map" style='width: 800px; height: 400px;'></div>
      <%end%>
   </div>
   <div id="results">
    <%if @listings then %>

	    <% @listings.each do |listing|%>
	      <%= div_for listing, :class => "result location#{listing.id}" do %>
		    <div class="content">
		      <h3 class="title">
		        <a href="/listings/show?listing_id=<%=listing.id%>" style=""><%= listing.title %></a>
		      </h3>
		      <p class="listingInfo">Address: <%= "#{listing.street}, #{listing.city}, #{listing.state} #{listing.zip}" %></p>
		    </div>
	      <% end %>
	   <% end %>
	<% end %>
  </div>
</div>


<script src= "//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript">
</script> 
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'>
</script>
<script type="text/javascript">
   $(document).ready(function() {
   var markers;
   var oldMarker;
   handler = Gmaps.build('Google');
   handler.buildMap({ internal: {id: 'map'}}, function(){
      var temp = {};
      _.each(<%=raw @markers.to_json %>, function(json, index){
         $(".location" + json.id).on('mouseenter', function() {
            var blah = markers[index]
            markers[index] = handler.addMarker(json, { "opacity": 1.0 });
            handler.removeMarker(blah);
         });
         $(".location" + json.id).on('mouseleave', function() {
            var blah = markers[index]
            markers[index] = handler.addMarker(json, { "opacity": 0.2 });
            handler.removeMarker(blah);
         });

         temp[index] = json;
      });
      markers = handler.addMarkers(temp, { "opacity": 0.2 });
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
   });
   });
</script>

