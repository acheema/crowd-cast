<!--Written by: Akaljot Cheema -->
<!--Maps and GPS portions written by: Jhoong Roh -->
<div class="container main">
   <h2>Create your listing</h2>
   <form class="form-horizontal col-lg-8 col-lg-offset-2">
      <div class="form-group">
         <label for="title">Title</label> <input class="form-control"
            id="title" placeholder="Enter title" type="text">
      </div>
      <div class="form-group info">
         <label>Address</label>
         <div class="form-inline">
            <div class="form-group">
               <input class="form-control address" id="street"
                  placeholder="Enter street" type="text">
            </div>
            <div class="form-group">
               <input class="form-control address" id="city"
                  placeholder="Enter city" type="text">
            </div>
            <div class="form-group">
               <input class="form-control address" id="state"
                  placeholder="Enter state" type="text">
            </div>
            <div class="form-group">
               <input class="form-control address" id="zip"
                  placeholder="Enter zip" type="number">
            </div>
         </div>
      </div>
      <div class="form-group">
         <label>GPS Location</label>
         <div class="form-inline">
            <div class="form-group">
               <input class="form-control gps" id="lat" placeholder="Enter latitude" type="text"> 
               <input class="form-control gps" id="lng" placeholder="Enter longitude" type="text">
            </div>
            <div class="form-group">
               <div class="select-gps" id="select_location"></div>
            </div>
         </div>
      </div>
      <div class = 'form-group'>
         <div class = "col-lg-12">
            <div class="col-lg-4">
               <div class="form-group info">
                  <div class='form-inline'>
                     <label class="control-label" for="height">Height</label> 
                     <input class="form-control" id="height" placeholder="Enter height" type="number">
                     <label class="control-label" for="width">Width</label>
                     <input class="form-control" id="width" placeholder="Enter width" type="number">
                  </div>
               </div>
            </div>
            <div class="col-lg-4">
               <div class="form-group info">
                  <div class='form-inline'>
                     <label for="views">Views per week</label> <input class=
                        "form-control" id="views" placeholder="Enter views"
                        type="number"> <label for="cost">Cost per week</label>
                     <input class="form-control" id="cost" placeholder=
                        "Enter cost" type="number">
                  </div>
               </div>
            </div>
            <div class="col-lg-4">
               <div class="form-group info">
                  <div class='form-inline'>
                     <label for="time">Time per click</label> 
                     <input class="form-control" id="time" placeholder="Enter time (s)" type="number"> 
                     <label for="resolution">Screen Resolution X</label> 
                     <input class="form-control" id="screen_resolution_x" placeholder="Enter resolution" type="number"> 
                  </div>
               </div>
            </div>
            <div class="col-lg-4">
               <div class="form-group info">
                  <div class='form-inline'>
                     <label for="resolution">Screen Resolution Y</label> 
                     <input class="form-control" id="screen_resolution_y" placeholder="Enter resolution" type="number">
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="form-group">
         <label for="description">Description</label>
         <textarea class="form-control" id="description" placeholder="Enter more information" rows="6">
         </textarea>
      </div>
      <div class="form-group">
         <div class="col-lg-offset-1 col-lg-10">
            <button class="btn btn-default" id="submit" type="submit">Submit</button>
         </div>
      </div>
   </form>
   <!--Image upload - work in progress
      <div class="form-group">
         <input id="file" type="file" multiple=true>
      </div>
      -->
   <%= form_for :listing, :html => { :multipart => true } do |form| %>
   <%= form.file_field :image %>
   <% end %>
</div>
<script type="text/javascript">
   $(document).ready(function() {
       var oldMarker;
       handler = Gmaps.build('Google');
   
       //When the address changes, create a marker on the map
       $('.address').change(function() {
          listingStreet = document.getElementById('street').value;
          listingCity = document.getElementById('city').value;
          listingState = document.getElementById('state').value;
          listingZip = document.getElementById('zip').value;
   
          if ((listingStreet != "") && (listingCity != "") && (listingState != "") && (listingZip != "")){
             clearGPS();
             var url = "http://maps.googleapis.com/maps/api/geocode/json?address=";
             url += listingStreet.replace(" ","+") + ",";
             url += listingCity.replace(" ","+") + ",";
             url += listingState + "," + listingZip;
             //Get request the GPS coordinates of this address
             $.ajax({
                url: url,
                type: "GET",
                success: function( data ) {
                   var location = data["results"][0]["geometry"]["location"];
                   json = { "lat": location["lat"], "lng": location["lng"] };
                   if (oldMarker != null){
                     handler.removeMarker(oldMarker);
                   }
   
                   oldMarker = handler.addMarker(json, { "draggable": true } );
                   oldMarker.panTo();
                   handler.getMap().setZoom(14);
                   markerMouseUp();
                }
             });
         }
       });
   
       //When the user inputs GPS coordinates, create a marker
       $('.gps').change(function() {
          listingLat = document.getElementById('lat').value;
          listingLng = document.getElementById('lng').value;
          if ((listingLat != "") && (listingLng != "")){
             clearAddress();
             if (oldMarker != null){
               handler.removeMarker(oldMarker);
             }
             json = { "lat": listingLat, "lng": listingLng };
             oldMarker = handler.addMarker(json, { "draggable": true } );
             oldMarker.panTo();
             handler.getMap().setZoom(14);
             markerMouseUp();
          }
       });
   
       $('#submit').click(function(e) {
         console.log("hello");
          e.preventDefault();
          listingTitle = $('#title').val();
          listingHeight = $('#height').val();
          listingWidth = $('#width').val();
          listingTime = $('#time').val();
          listingViews = $('#views').val();
          listingCost = $('#cost').val();
          listingResolutionX = $('#screen_resolution_x').val();
          listingResolutionY = $('#screen_resolution_y').val();
          listingStreet = $('#street').val();
          listingCity = $('#city').val();
          listingState = $('#state').val();
          listingZip = $('#zip').val();
          listingLat = document.getElementById('lat').value;
          listingLng = document.getElementById('lng').value;
          listingDescription = $('#description').val();
          $.ajax({
              type: 'POST',
              url: window.location.protocol + '//' + window.location.host + "/api/create_listing/",
              data: JSON.stringify({ title: listingTitle, height: listingHeight, width: listingWidth,
                  time_per_click: listingTime, views_per_week: listingViews, cost_per_week: listingCost,
                  screen_resolution_x: listingResolutionX, street: listingStreet, city: listingCity,
                  state: listingState, zip: listingZip, screen_resolution_y: listingResolutionY,
                  latitude: listingLat, longitude: listingLng, description: listingDescription }),
              contentType: "application/json",
              dataType: "json",
              success: function(data) {
                handle_response(data)
              },
              failure: function(data) { alert("Failure"); }
            });
       });
   
      function handle_response(data) {
        if(data['status'] > 0){
          window.location.href = window.location.protocol + '//' + window.location.host + "/listings/show?listing_id=" + data['status'];
        }
        else{
          handle_error(data);
        }
      }
   
      function handle_error(data){
        response = data['status']
        if(response == -1){
          alert("Error, malformed title")
        }
        else if (response == -2){
          alert("Error, malformed height")
        }
        else if (response == -3){
          alert("Error, malformed width")
        }
        else if (response == -4){
          alert("Error, malformed time per click")
        }
        else if (response == -5){
          alert("Error, malformed views per week")
        }
        else if (response == -6){
          alert("Error, malformed cost per week")
        }
        else if (response == -7){
          alert("Error, malformed street")
        }
        else if (response == -8){
          alert("Error, malformed city")
        }
        else if (response == -9){
          alert("Error, malformed state")
        }
        else if (response == -10){
          alert("Error, malformed zip")
        }
        else if (response == -11){
          alert("Error, you must sign in or create an account ")
        }
        else if (response == -12){
          alert("Error, you must have valid screen resolution x ")
        }
        else if (response == -13){
          alert("Error, you must have valid screen resolution y ")
        }
        else{
          alert("An error occured while trying to create your listing, please try again.")
        }
      }
   
       //Add markers when the user interacts with the map
       handler.buildMap({ internal: {id: 'select_location'}, provider: { zoom: 10, center: new google.maps.LatLng(37.75, -122.2833)} }, function(){
          google.maps.event.addListener(handler.getMap(), 'click', function(object){
             var lat = object.latLng.lat();
             var lng = object.latLng.lng();
             var json = { "lat": object.latLng.lat(), "lng": object.latLng.lng() };
             if (oldMarker != null){
                handler.removeMarker(oldMarker);
             }
             oldMarker = handler.addMarker(json, { "draggable": true } );
             setLatLng(lat, lng);
             markerMouseUp();
          });
          handler.fitMapToBounds();
       });
   
      //When the user stops dragging the marker, we set the GPS fields
      function markerMouseUp() {
         google.maps.event.addListener(oldMarker.getServiceObject(), 'mouseup', function(object){
            lat = object.latLng.lat();
            lng = object.latLng.lng();
            setLatLng(lat, lng);
         });
      }
      //Set the GPS fields while clearing the address fields
      function setLatLng(lat, lng){
         document.getElementById('lat').value = lat;
         document.getElementById('lng').value = lng;
         clearAddress();
      }
      //Clear the address fields.
      function clearAddress(){
         document.getElementById('street').value = null;
         document.getElementById('city').value = null;
         document.getElementById('state').value = null;
         document.getElementById('zip').value = null;
      }
      //Clear the GPS fields
      function clearGPS(){
         document.getElementById('lat').value = null;
         document.getElementById('lng').value = null;
      }
   
   
    });
</script>
<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry"type="text/javascript"></script> 
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> 
<script src="http://cdnjs.cloudflare.com/ajax/libs/jasny-bootstrap/3.1.3/js/jasny-bootstrap.min.js"></script>
